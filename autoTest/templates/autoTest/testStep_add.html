{% extends 'autoTest/base.html' %}
{% block title %} 添加用例 {% endblock %}
{% block crumbs %}
    <div class="row">
        <div class="col-md-12">
            <ol class="breadcrumb">
                <li>
                    <a href="/index/">主页</a>
                </li>
                <li class="active">
                    <a class="this">基础信息</a>
                </li>
                <li class="active">
                    <a class="this-page">添加用例</a>
                </li>
            </ol>

        </div>
    </div>
{% endblock %}
{% block body %}
<div class="row">
    <div class="col-md-12">
        <div class="panel">
            <div class="panel-heading">
                <h3 class="panel-title">添加用例</h3>
            </div>
            <div class="panel-body">
                <div class="form-horizontal">
                    <div class="form-group">
                        <label for="testStep_name" class="col-sm-2 control-label"><span style="color: red">* </span>用例名称:</label>
                        <div class="col-sm-6">
                            <input type="text" name="testStep_name" class="form-control"  id="testStep_name" placeholder="请输入内容">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label"><span style="color: red">* </span>选择用例所属项目:</label>
                        <div class="col-sm-6">
                            <select id="pro_id" class="form-control">
                                <option value=""> </option>
                                {% for pro in pro_list %}
                                    <option value={{ pro.pro_id }}>{{ pro.pro_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label"><span style="color: red">* </span>选择接口:</label>
                        <div class="col-sm-6">
                            <select id="api_id" class="form-control">
                                <option value=""> </option>
                            </select>
                        </div>
                    </div>
<!-- 修改请求地址样式 -->
                    <div class="form-group">
                        <label for="url" class="col-sm-2 control-label"><span style="color: red" >* </span>请求地址:</label>
                        <div class="col-sm-3">
                            <input type="url" list="url_list" id="url" class="form-control" name="link" />
                                <datalist id="url_list">          
                                </datalist>
                        </div>
                        <div class="col-sm-3" style="margin-left: -30px;">
                            <input type="text" name="uri" class="form-control"  id="uri" placeholder="请输入uri地址">
                            <span  class="help-block" style="color:red">e.g. ①/aa/bb/cc </span>
                        </div>

                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label"><span style="color: red">* </span>是否无条件跳过此用例:</label>
                        <div class="col-sm-6">
                            <label class="radio-inline">
                                <input type="radio" name="skip" value="True"> 是
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="skip" value="False" checked="checked"> 否
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="skipIf" class="col-sm-2 control-label">skipIf:</label>
                        <div class="col-sm-6">
                            <input type="text" name="skipIf" class="form-control" id="skipIf" placeholder="请输入内容,可默认为空">
                            <span id="" class="help-block" style="color:red">执行函数  e.g. ${functionName(*args, **kwargs)}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="skipUnless" class="col-sm-2 control-label">skipUnless:</label>
                        <div class="col-sm-6">
                            <input type="text" name="skipUnless" class="form-control" id="skipUnless" placeholder="请输入内容,可默认为空">
                            <span   class="help-block" style="color:red">执行函数  e.g. ${functionName(*args, **kwargs)}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="times" class="col-sm-2 control-label"><span style="color: red">* </span>执行次数:</label>
                        <div class="col-sm-6">
                            <input type="text" name="times" class="form-control"  id="times" value="1" placeholder="请输入内容">
                            <span   class="help-block" style="color:red">用例默认执行一次</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label"><span style="color: red">* </span>请求方式:</label>
                        <div class="col-sm-6">
                            <label class="radio-inline">
                                <input type="radio" name="method" value="GET"> GET
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="method" value="POST"> POST
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="method" value="DELETE"> DELETE
                            </label> 
                            <label class="radio-inline">
                                <input type="radio" name="method" value="HEAD"> HEAD
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label"><span style="color: red">* </span>参数格式:</label>
                        <div class="col-sm-6">
                            <label class="radio-inline">
                                <input type="radio" name="content_type" value="params" onclick=show_table()> params
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="content_type" value="form-data" onclick=show_table()> form-data
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="content_type" value="x-www-form-urlencoded" onclick=show_table()> x-www-form-urlencoded
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="content_type" value="json" onclick=show_textarea()> json
                            </label> 
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description" class="col-sm-2 control-label">用例内容描述:</label>
                        <div class="col-sm-6">
                            <textarea name="description" placeholder="请输入内容" class="form-control" id="description" rows="3"></textarea>
                        </div>
                    </div>
                    <!-- 静态变量 -->
                    <div class="form-group">
                        <label for="" class="col-sm-2 control-label">静态变量:</label>
                        <div class="col-sm-6">
                            <!-- <input type="text" name="variables" class="form-control"  id="variables" placeholder="请输入内容"> -->
                            <div>
                                <table class="table table-bordered table-condensed" id="variables-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px"><b>Key</b></th>
                                            <th style="width: 100px"><b>Value</b></th>
                                            <th style="width: 100px"><b>是否必须</b></th>
                                            <th style="width: 100px"><b>数据类型</b></th>
                                            <th><b>描述</b></th>
                                            <th style="width: 100px"><b>操作</b></th>
                                        </tr>
                                    </thead>
                                    <tbody> 
                                        
                                    </tbody>
                                </table>
                                <span   class="help-block" style="color:red">引用前面接口提取变量的形式: "$extract_name"</span>
                            </div>
                            <div class="col-sm-offset-4">
                                <button class="btn btn-primary" onclick="add_variables_row()">添加静态变量</button>
                            </div>
                        </div>
                    </div>
                    <!-- 请求头 -->
                    <div class="form-group">
                        <label for="" class="col-sm-2 control-label">请求头:</label>
                        <div class="col-sm-6">
                            <!-- <input type="text" name="headers" class="form-control"  id="headers" placeholder="请输入内容"> -->
                            <div>
                                <table class="table table-bordered table-condensed" id="headers-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px"><b>Key</b></th>
                                            <th style="width: 100px"><b>Value</b></th>
                                            <th style="width: 100px"><b>是否必须</b></th>
                                            <th style="width: 100px"><b>数据类型</b></th>
                                            <th><b>描述</b></th>
                                            <th style="width: 100px"><b>操作</b></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-sm-offset-4">
                                <button class="btn btn-primary" onclick="add_headers_row()">添加请求头</button>
                            </div>
                        </div>
                    </div>
                    <!-- 请求体 -->
                    <div class="form-group">
                        <label for="" class="col-sm-2 control-label">请求体:</label>
                        <div class="col-sm-6" id="body-textarea-div" hidden="hidden">
                            <textarea name="body" placeholder="请输入内容" class="form-control" id="body-textarea" rows="4"></textarea>
                        </div>
                        <div class="col-sm-6" id="body-table-div">
                            <div>
                                <table class="table table-bordered table-condensed" id="body-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px"><b>Key</b></th>
                                            <th style="width: 100px"><b>Value</b></th>
                                            <th style="width: 100px"><b>是否必须</b></th>
                                            <th style="width: 100px"><b>数据类型</b></th>
                                            <th class="center-block"><b>描述</b></th>
                                            <th style="width: 100px"><b>操作</b></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-sm-offset-4">
                                <button class="btn btn-primary" onclick="add_body_row()">添加请求体</button>
                            </div>
                        </div>
                    </div>
                    <!-- 提取参数 -->
                    <div class="form-group">
                        <label for="" class="col-sm-2 control-label">提取变量:</label>
                        <div class="col-sm-6">
                            <!-- <input type="text" name="extract" class="form-control"  id="extract" placeholder="请输入内容"> -->
                            <div>
                                <table class="table table-bordered table-condensed" id="extract-table">
                                    <thead>
                                        <tr>
                                            <th><b>Key</b></th>
                                            <th><b>Value</b></th>
                                            <th><b>操作</b></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-sm-offset-4">
                                <button class="btn btn-primary" onclick="add_extract_row()">添加提取变量</button>
                            </div>
                        </div>
                    </div>
                    <!-- 校验器 -->
                    <div class="form-group">
                        <label for="" class="col-sm-2 control-label">校验器:</label>
                        <div class="col-sm-6">
                            <!-- <input type="text" name="validate" class="form-control"  id="validate" placeholder="请输入内容"> -->
                            <div>
                                <table class="table table-bordered table-condensed" id="validate-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 100px"><b>Key</b></th>
                                            <th style="width: 150px"><b>比较器</b></th>
                                            <th style="width: 150px"><b>Value</b></th>
                                            <th style="width: 100px"><b>数据类型</b></th>
                                            <th><b>描述</b></th>
                                            <th style="width: 150px"><b>操作</b></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-sm-offset-4">
                                <button class="btn btn-primary" onclick="add_validate_row()">添加校验器</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="setup_hooks" class="col-sm-2 control-label">setup_hooks:</label>
                        <div class="col-sm-6">
                            <input type="text" name="setup_hooks" class="form-control" id="setup_hooks" placeholder="请输入内容,可默认为空">
                            <span   class="help-block" style="color:red">在整个用例开始执行前触发 hook 函数，主要用于请求前的准备工作。也可以实现对请求的 request 内容进行预处理<br />e.g. ①${hook_print(setup)} ②${setup_hook_prepare_kwargs($request)}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="teardown_hooks" class="col-sm-2 control-label">teardown_hooks:</label>
                        <div class="col-sm-6">
                            <input type="text" name="teardown_hooks" class="form-control" id="teardown_hooks" placeholder="请输入内容,可默认为空">
                            <span   class="help-block" style="color:red">在 HTTP 请求发送后执行 hook 函数，主要用于测试后的清理工作；也可以实现对响应的 response 进行修改，例如进行加解密等处理。<br />e.g. ${teardown_hook_sleep_N_secs($response, 2)}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-offset-4 col-sm-6">
                            <button type="submit" class="btn btn-primary" onclick="submit_form()">保存</button>
                        </div>
                    </div>
                <!-- </form> -->
                </div>
            </div>

        </div>

    </div>

</div>


{% endblock %}

{% block javascript %}
<script type="text/javascript">
    $(document).ready(function(){
        $("#pro_id").change(function(){
            // 若切换项目，则同步切换接口下拉列表
            var pro_id = $("#pro_id option:selected").val();
            $.ajax({
                url: "/autoTest/find_data/",
                type: "post",
                data:{
                    "model": "pro",
                    "data_id": pro_id,
                    "data_name": "api_list",
                },
                success : function(data){
                    var api_list = eval(data);
                    var null_content = "<option value=''> </option>";
                    $("#api_id").empty();
                    $("#api_id").append(null_content);
                    for (var index=0;index<api_list.length;index++) {
                        var api_object = api_list[index];
                        var add_content = "<option value=" + api_object.api_id + ">" + api_object.api_name + "</option>";
                        $("#api_id").append(add_content);
                       
                    }
                },
                error : function(data){
                    console.log("查找指定项目接口失败")
                }
            });
        });
        $("#pro_id").change(function(){
            // 若切换项目，则同步切换请求地址下拉列表
            var pro_id = $("#pro_id option:selected").val();
            $.ajax({
                url: "/autoTest/find_data/",
                type: "post",
                data:{
                    "model": "pro",
                    "data_id": pro_id,
                    "data_name": "env_list",
                },
                success : function(data){
                    var env_list = eval(data);
                    console.log('env_list: ',env_list);
                    $("#url_list").empty();
                    for (var index=0;index<env_list.length;index++) {
                        var env_object = env_list[index];
                        var add_content = '<option label="' + env_object.env_name + '" value="' + env_object.url + ':' + env_object.port + '" />';
                        $("#url_list").append(add_content);
                        console.log('add_content: ',add_content);
                    }
                }
            });
        });
        // 变更接口，自动切换uri地址
        $("#api_id").change(function(){
            var api_id = $("#api_id option:selected").val();
            $.ajax({
                url: "/autoTest/find_data/",
                type: "post",
                data:{
                    "model": "api",
                    "data_id": api_id,
                    "data_name": "api_list",
                },
                success : function(data){
                    api_object = eval(data)[0];
                    api_uri = api_object.api_path;
                    $("#uri").val(api_uri);
                },
                error : function(data){
                    console.log("指定接口列表查询失败")
                }
            });
        });



        $("#api_id").change(function(){
            var api_id = $("#api_id option:selected").val();
            $.ajax({
                url: "/autoTest/find_data/",
                type: "post",
                data:{
                    "model": "api",
                    "data_id": api_id,
                    "data_name": "",
                },
                success : function(data){
                    var data_list = eval(data);
                    console.log('----data_list: ',data_list);
                    var row_content = new String;
                    var method = data_list[0]["method"];
                    var content_type = data_list[0]["content_type"];
                    var key = new String;
                    var comparator = new String;
                    var value = new String;
                    var headers_data = JSON.parse(data_list[0]["headers"]);
                    var necessaryFlag_dict = JSON.parse(data_list[0]["necessaryFlag_dict"]);
                    var dataType_dict = JSON.parse(data_list[0]["dataType_dict"]);
                    var description_dict = JSON.parse(data_list[0]["description_dict"]);

                    var headers_necessary_flag_list = necessaryFlag_dict["headers"];
                    var headers_data_type_list = dataType_dict["headers"];
                    var headers_description_list = description_dict["headers"];
                    var necessary_map = {'0':'非必填', '1':'必填'};

                    var body_data = JSON.parse(data_list[0]["body"]);
                    var body_necessary_flag_list = necessaryFlag_dict["body"];
                    var body_data_type_list = dataType_dict["body"];
                    var body_description_list = description_dict["body"];

                    var validate_data = JSON.parse(data_list[0]["validate"]);
                    var validate_description_list = description_dict["validate"];
                    var validate_data_type_list = dataType_dict["validate"];

                    var index = 0;
                    //切换接口，自动勾选请求方式
                    var method_locator = "input[name='method'][value='" + method + "']";
                    $("input[name=method][checked=checked]").removeAttr("checked");
                    $(method_locator).attr("checked","checked");
                    //切换接口，自动勾选请求参数格式
                    var content_type_locator = "input[name='content_type'][value='" + content_type + "']";
                    $("input[name=content_type][checked=checked]").removeAttr("checked");
                    $(content_type_locator).attr("checked","checked");
                    // 切换接口，则清空原有数据
                    $("#headers-table tbody").empty();
                    $("#body-table tbody").empty();
                    $("#validate-table tbody").empty();
                    // 根据接口报文格式显示textarea或者表格
                    if(content_type === 'json'){
                        show_textarea();
                    }
                    else{
                        show_table();
                    }

                    // 填充headers

                    for (key in headers_data){
                        value = headers_data[key];
                        var headers_description_index = headers_description_list[index];
                        // 如果之前未填写字段，则默认显示空值
                        if(headers_description_index == undefined){
                            headers_description_index = '';
                        }
                        var necessary = headers_necessary_flag_list[index];
                        row_content = '<tr><td contenteditable="true" name="key">' + key + '</td><td contenteditable="true" name="value">' + value + '</td><td contenteditable="true" name="headers_necessary_flag">' + '<select name="headers_necessary_flag" class="form-control">' + '<option value="'+ necessary +'"> '+ necessary_map[necessary] +' </option>' + '<option value="1"> 必填 </option>' + '<option value="0"> 非必填 </option>' + '</select>' + '</td><td contenteditable="true" name="headers_data_type">' + '<select name="headers_data_type" class="form-control">' + '<option value="' + headers_data_type_list[index] + '">' + headers_data_type_list[index] + ' </option>' + '<option value="string"> string </option>' + '<option value="int"> int </option>' + '<option value="double"> double </option>' + '<option value="list"> list </option>' + '<option value="dict"> dict </option>' + '</select>' + '</td><td contenteditable="true" name="headers_description">' + headers_description_index + '</td><td><button class="btn btn-danger" onclick="del_row(this)">删除</button></td></tr>';
                        index = index + 1;
                        $("#headers-table tbody").append(row_content);

                    }
                    // 填充body
                    index = 0;
                    $("#body-textarea").val(data_list[0]["body"]);  //自动填充body_textarea数据
                    for (key in body_data){
                        value = body_data[key];
                        var body_description_index = body_description_list[index];
                        // 如果之前未填写字段，则默认显示空值
                        if(body_description_index == undefined){
                            body_description_index = '';
                        }
                        var necessary = body_necessary_flag_list[index];
                        row_content = '<tr><td contenteditable="true" name="key">' + key + '</td><td contenteditable="true" name="value">' + value + '</td><td contenteditable="true" name="body_necessary_flag">' + '<select name="body_necessary_flag" class="form-control">' + '<option value="'+ necessary +'"> '+ necessary_map[necessary] +' </option>' + '<option value="1"> 必填 </option>' + '<option value="0"> 非必填 </option>' + '</select>' + '</td><td contenteditable="true" name="body_data_type">' + '<select name="body_data_type" class="form-control">' + '<option value="' + body_data_type_list[index] + '">' + body_data_type_list[index] + ' </option>' + '<option value="string"> string </option>' + '<option value="int"> int </option>' + '<option value="double"> double </option>' + '<option value="list"> list </option>' + '<option value="dict"> dict </option>' + '</select>' + '</td><td contenteditable="true" name="body_description">' + body_description_index + '</td><td><button class="btn btn-danger" onclick="del_row(this)">删除</button></td></tr>';
                        index = index + 1;
                        $("#body-table tbody").append(row_content);

                    }
                    //  填充validate
                    index = 0;
                    var key = new String;
                    var value = new String;
                    var comparator = new String;
                    var row_content = new String;
                    $.each(validate_data, function(i, item){  
                    // for (item in validate){
                        var validate_description_index = validate_description_list[index];
                        // 如果之前未填写字段，则默认显示空值
                        if(validate_description_index == undefined){
                            validate_description_index = '';
                        }
                        try{
                            var temp_validate = validate_data_type_list[index];
                        } catch(TypeError){
                            var temp_validate = "string";
                        }
                        comparator = Object.keys(item)[0];
                        key = item[comparator][0];
                        value = item[comparator][1];
                        row_content = '<tr><td contenteditable="true" name="key">'+ key + '</td><td contenteditable="true" name="comparator">'+ '<select name="comparator" class="form-control">' + '<option value=' + comparator + '>' + comparator + '</option>'+ '<option value="eq"> = </option>' + '<option value="gt"> > </option>' + '<option value="ge"> >= </option>' + '<option value="lt"> < </option>' + '<option value="le"> <= </option>' + '<option value="len_eq">长度等于</option>' + '<option value="len_gt">长度大于</option>' + '<option value="len_lt">长度小于</option>' + '<option value="contains">包含</option>' + '<option value="contained_by">被包含</option>' + '<option value="startswith">startswith</option>' + '<option value="endswith">endswith</option>' +'</select>' + '</td>' + '<td contenteditable="true" name="value">' + value + '</td>' + '<td contenteditable="true" name="validate_data_type">'+ '<select name="validate_data_type" class="form-control">' + '<option value="' + temp_validate + '">' + temp_validate + ' </option>' + '<option value="string"> string </option>' + '<option value="int"> int </option>' + '<option value="double"> double </option>' + '<option value="list"> list </option>' + '<option value="dict"> dict </option>' + '</select>' + '</td>' + '<td contenteditable="true" name="validate_description">'+ validate_description_index + '</td><td><button class="btn btn-danger" onclick="del_row(this)">删除</button></td></tr>';
                        index = index + 1;
                        $("#validate-table tbody").append(row_content);
                    });

                },
                error: function(){
                    console.log("调用接口失败！");
                }
            });
        });
    });

// 添加headers行
    function add_headers_row(){
        var necessary_flag_content = '<select name="headers_necessary_flag" class="form-control">' + '<option value="1"> 必填 </option>' + '<option value="0"> 非必填 </option>' + '</select>';
        var data_type_content = '<select name="headers_data_type" class="form-control">' + '<option value="string"> string </option>' + '<option value="int"> int </option>' + '<option value="double"> double </option>' + '<option value="list"> list </option>' + '<option value="dict"> dict </option>' + '</select>';
                row_content = '<tr><td contenteditable="true" name="key"></td><td contenteditable="true" name="value"></td><td contenteditable="true" name="headers_necessary_flag">'+ necessary_flag_content +'</td><td contenteditable="true" name="headers_data_type">'+ data_type_content +'</td><td contenteditable="true" name="headers_description"></td><td><button class="btn btn-danger" onclick="del_row(this)">删除</button></td></tr>';
                $("#headers-table tbody").append(row_content);
            }
// 添加body行
    function add_body_row(){
        var necessary_flag_content = '<select name="body_necessary_flag" class="form-control">' + '<option value="1"> 必填 </option>' + '<option value="0"> 非必填 </option>' + '</select>';
        var data_type_content = '<select name="body_data_type" class="form-control">' + '<option value="string"> string </option>' + '<option value="int"> int </option>' + '<option value="double"> double </option>' + '<option value="list"> list </option>' + '<option value="dict"> dict </option>' + '</select>';
                row_content = '<tr><td contenteditable="true" name="key"></td><td contenteditable="true" name="value"></td><td contenteditable="true" name="body_necessary_flag">'+ necessary_flag_content +'</td><td contenteditable="true" name="body_data_type">'+ data_type_content +'</td><td contenteditable="true" name="body_description"></td><td><button class="btn btn-danger" onclick="del_row(this)">删除</button></td></tr>';
                $("#body-table tbody").append(row_content);
            }
// 添加校验器行
    function add_validate_row(){
                var data_type_content = '<select name="headers_data_type" class="form-control">' + '<option value="string"> string </option>' + '<option value="int"> int </option>' + '<option value="double"> double </option>' + '<option value="list"> list </option>' + '<option value="dict"> dict </option>' + '</select>';
                var select_content = '<select name="comparator" class="form-control">' + '<option value="eq"> = </option>' + '<option value="gt"> > </option>' + '<option value="ge"> >= </option>' + '<option value="lt"> < </option>' + '<option value="le"> <= </option>' + '<option value="len_eq">长度等于</option>' + '<option value="len_gt">长度大于</option>' + '<option value="len_lt">长度小于</option>' + '<option value="contains">包含</option>' + '<option value="contained_by">被包含</option>' + '<option value="startswith">startswith</option>' + '<option value="endswith">endswith</option>' +'</select>';
                row_content = '<tr><td contenteditable="true" name="key"></td>' +'<td contenteditable="true" name="comparator">' + select_content + '</td>' + '<td contenteditable="true" name="value"></td>'+
                '<td contenteditable="true" name="validate_data_type">'+ data_type_content + '</td>' +'<td contenteditable="true" name="validate_description"></td><td><button class="btn btn-danger" onclick="del_row(this)">删除</button></td></tr>';
                $("#validate-table tbody").append(row_content);
            }

// 添加提取参数行
    function add_extract_row(){
                row_content = '<tr><td contenteditable="true" name="key"></td><td contenteditable="false" name="value"></td><td><button class="btn btn-danger" onclick="del_row(this)">删除</button></td></tr>';
                $("#extract-table tbody").append(row_content);
            }
// 添加静态变量行
    function add_variables_row(){
                var necessary_flag_content = '<select name="body_necessary_flag" class="form-control">' + '<option value="1"> 必填 </option>' + '<option value="0"> 非必填 </option>' + '</select>';
                var data_type_content = '<select name="headers_data_type" class="form-control">' + '<option value="string"> string </option>' + '<option value="int"> int </option>' + '<option value="double"> double </option>' + '<option value="list"> list </option>' + '<option value="dict"> dict </option>' + '</select>';
                row_content = '<tr><td contenteditable="true" name="key"></td><td contenteditable="true" name="value"></td>'+ '<td contenteditable="true" name="variables_necessary_flag">'+ necessary_flag_content + '</td><td contenteditable="true" name="variables_data_type">'+ data_type_content + '</td>' +'<td contenteditable="true" name="variables_description"></td><td><button class="btn btn-danger" onclick="del_row(this)">删除</button></td></tr>';
                $("#variables-table tbody").append(row_content);
            }
// 若选择报文格式为json，body隐藏表格，显示textarea
    function show_textarea(){
        $("#body-textarea-div").removeAttr("hidden");
        $("#body-table-div").attr("hidden", "hidden");
    }

// 若选择报文格式为非json，body显示表格，隐藏textarea
    function show_table(){
        $("#body-table-div").removeAttr("hidden");
        $("#body-textarea-div").attr("hidden", "hidden");
    }

// 提交表单
    function submit_form(){
        var testStep_name = $("#testStep_name").val();
        var api_id = $("#api_id").val();
        var pro_id = $("#pro_id").val();
        var url = $("#url").val() + $("#uri").val();
        var skip = $("input[name='skip']:checked").val();
        var skipIf = $("#skipIf").val();
        var skipUnless = $("#skipUnless").val();
        var times = $("#times").val();
        var method = $("input[name='method']:checked").val();
        var content_type = $("input[name='content_type']:checked").val();
        var description = $("#description").val();
        var setup_hooks = $("#setup_hooks").val();
        var teardown_hooks = $("#teardown_hooks").val();

        var headers = new Object();
        var headers_key_list = new Array();
        var headers_value_list = new Array();

        var body_from_textarea = $("#body-textarea").val();
        var body = new Object();
        var body_key_list = new Array();
        var body_value_list = new Array();

        var validate = new Object();
        var validate_key_list = new Array();
        var validate_value_list = new Array();
        var validate_row = new Object();
        var validate_list = new Array();

        var variables = new Object();
        var variables_necessary_flag_list = new Array();
        var variables_data_type_list = new Array();
        var variables_description_list = new Array();
        var variables_list = new Array();
        var variables_key_list = new Array();
        var variables_value_list = new Array();

        var extract = new Object();
        var extract_list = new Array();
        var extract_key_list = new Array();
        var extract_value_list = new Array();

        var headers_necessary_flag_list = new Array();
        var headers_data_type_list = new Array();
        var headers_description_list = new Array();

        var body_necessary_flag_list = new Array();
        var body_data_type_list = new Array();
        var body_description_list = new Array();

        var validate_data_type_list = new Array();
        var validate_description_list = new Array();

        var necessaryFlag_dict = new Object();
        var dataType_dict = new Object();
        var description_dict = new Object();
// 遍历headers数据
        $("#headers-table tr td").each(function (i){
                if($(this).attr("name")==="key"){
                   headers_key_list.push( $(this).text() );
                };
                if($(this).attr("name")==="value"){
                   headers_value_list.push( $(this).text() );
                };
                if($(this).attr("name")==="headers_necessary_flag"){
                   headers_necessary_flag_list.push( $(this).children("select").val());
                };
                if($(this).attr("name")==="headers_data_type"){
                   headers_data_type_list.push( $(this).children("select").val());
                };
                if($(this).attr("name")==="headers_description"){
                   headers_description_list.push( $(this).text() );
                };
            });
        $.each(headers_key_list,function(i){
                headers[headers_key_list[i]] = headers_value_list[i];
            });
        var headers_str = JSON.stringify(headers);
        necessaryFlag_dict["headers"] = headers_necessary_flag_list;
        dataType_dict["headers"] = headers_data_type_list;
        description_dict["headers"] = headers_description_list;
// 遍历body数据
        $("#body-table tr td").each(function (i){
                if($(this).attr("name")==="key"){
                   body_key_list.push( $(this).text() );
                };
                if($(this).attr("name")==="value"){
                   body_value_list.push( $(this).text() );
                };
                if($(this).attr("name")==="body_necessary_flag"){
                   body_necessary_flag_list.push( $(this).children("select").val());
                };
                if($(this).attr("name")==="body_data_type"){
                   body_data_type_list.push( $(this).children("select").val());
                };
                if($(this).attr("name")==="body_description"){
                   body_description_list.push( $(this).text() );
                };
            });
        $.each(body_key_list,function(i){
                body[body_key_list[i]] = body_value_list[i];
            });
        var body_str = JSON.stringify(body);
        necessaryFlag_dict["body"] = body_necessary_flag_list;
        dataType_dict["body"] = body_data_type_list;
        description_dict["body"] = body_description_list;
        var final_body = new String();
        if(content_type === 'json'){
            final_body = body_from_textarea;
        }
        else{
            final_body = body_str;
        }
// 遍历validate数据
        $("#validate-table tbody>tr").each(function (i){
            validate_value_list = new Array();
            var tr_index = i;
            var tr_css_locator = "#validate-table tbody>tr:eq("+ i +")>td[name]"
            $(tr_css_locator).each(function (x){
                if($(this).attr("name")==="key"){
                    validate_value_list.push( $(this).text() );
                };
                if($(this).attr("name")==="value"){
                   validate_value_list.push( $(this).text() );
                };
                if($(this).attr("name")==="comparator"){
                   comparator_tmp = $(this).children("select").val();
                };
                if($(this).attr("name")==="validate_data_type"){
                   validate_data_type_list.push(  $(this).children("select").val());
                };
                if($(this).attr("name")==="validate_description"){
                   validate_description_list.push( $(this).text() );
                };

            });

            validate_row[comparator_tmp] = validate_value_list;
            comparator_tmp = new String;
            validate_list.push( validate_row );
            validate_row = new Object;
        });
        
        dataType_dict["validate"] = validate_data_type_list;    
        description_dict["validate"] = validate_description_list;
        var validate_str = JSON.stringify(validate_list);

// 遍历variables数据
        $("#variables-table tr td").each(function (i){
                if($(this).attr("name")==="key"){
                   variables_key_list.push( $(this).text() );
                };
                if($(this).attr("name")==="value"){
                   variables_value_list.push( $(this).text() );
                };
                if($(this).attr("name")==="variables_necessary_flag"){
                   variables_necessary_flag_list.push( $(this).children("select").val());
                };
                if($(this).attr("name")==="variables_data_type"){
                   variables_data_type_list.push( $(this).children("select").val());
                };
                if($(this).attr("name")==="variables_description"){
                   variables_description_list.push( $(this).text() );
                };
            });
        $.each(variables_key_list,function(i){
                variables[variables_key_list[i]] = variables_value_list[i];
                variables_list.push(variables);
                variables = new Object;
            });
        necessaryFlag_dict["variables"] = variables_necessary_flag_list;
        dataType_dict["variables"] = variables_data_type_list;
        description_dict["variables"] = variables_description_list;
        var variables_str = JSON.stringify(variables_list);

// 遍历extract数据
        $("#extract-table tr td").each(function (i){
                if($(this).attr("name")==="key"){
                   extract_key_list.push( $(this).text() );
                };
                if($(this).attr("name")==="value"){
                   extract_value_list.push( $(this).text() );
                };
            });
        $.each(extract_key_list,function(i){
                extract[extract_key_list[i]] = extract_value_list[i];
                extract_list.push(extract);
                extract = new Object;
            });
        var extract_str = JSON.stringify(extract_list);
        var necessaryFlag_dict_str = JSON.stringify(necessaryFlag_dict);
        var dataType_dict_str = JSON.stringify(dataType_dict);
        var description_dict_str = JSON.stringify(description_dict);

        // 提交表单
        $.ajax({
            url: "/autoTest/testStep_add/",
            type: "post",
            data: {
                "testStep_name": testStep_name,
                "api_id": api_id,
                "pro_id": pro_id,
                "url": url,
                "skip": skip,
                "skipIf": skipIf,
                "skipUnless": skipUnless,
                "times": times,
                "method": method,
                "content_type": content_type,
                "description": description,
                "setup_hooks": setup_hooks,
                "teardown_hooks": teardown_hooks,
                "headers": headers_str,
                "body": final_body,
                "variables": variables_str,
                "validate": validate_str,
                "extract": extract_str,
                "necessaryFlag_dict": necessaryFlag_dict_str,
                "dataType_dict": dataType_dict_str,
                "description_dict": description_dict_str

            },
            // dataType: "json",
            success: function () {
                // console.log(
                //     "testStep_name: ",testStep_name,
                //     "\napi_id: ", api_id,
                //     "\npro_id: ", pro_id,
                //     "\nurl: ", url,
                //     "\nskip: ", skip,
                //     "\nskipIf: ", skipIf,
                //     "\nskipUnless: ", skipUnless,
                //     "\ntimes: ", times,
                //     "\nmethod: ", method,
                //     "\ndescription: ", description,
                //     "\nsetup_hooks: ", setup_hooks,
                //     "\nteardown_hooks: ", teardown_hooks,
                //     "\nheaders: ", headers_str,
                //     "\nbody: ", body_str,
                //     "\nvariables: ", variables_str,
                //     "\nvalidate: ", validate_str,
                //     "\nextract: ", extract_str,
                //     "\nnecessaryFlag_dict: ", necessaryFlag_dict_str,
                //     "\ndataType_dict: ", dataType_dict_str,
                //     "\ndescription_dict: ", description_dict_str

                //     );
                alert("保存成功!");
                console.log('------body_str: ', body_str);
                // window.location.replace("/autoTest/testStep_index/");
            },
            error: function(){
                console.log(
                    "testStep_name: ",testStep_name,
                    "\napi_id: ", api_id,
                    "\npro_id: ", pro_id,
                    "\nurl: ", url,
                    "\nskip: ", skip,
                    "\nskipIf: ", skipIf,
                    "\nskipUnless: ", skipUnless,
                    "\ntimes: ", times,
                    "\nmethod: ", method,
                    "\ndescription: ", description,
                    "\nsetup_hooks: ", setup_hooks,
                    "\nteardown_hooks: ", teardown_hooks,
                    "\nheaders: ", headers_str,
                    "\nbody: ", body_str,
                    "\nvariables: ", variables_str,
                    "\nvalidate: ", validate_str,
                    "\nextract: ", extract_str,
                    "\nnecessaryFlag_dict: ", necessaryFlag_dict_str,
                    "\ndataType_dict: ", dataType_dict_str,
                    "\ndescription_dict: ", description_dict_str

                    );
                
            }
        });
    }

</script>
{% endblock %}